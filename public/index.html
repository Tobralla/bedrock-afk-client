<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DonutSMP Bot Manager</title>
    <style>
        body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .shard-box { background: #1f1f1f; border: 2px solid #ff9d00; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .shard-box h1 { margin: 0; font-size: 3em; color: #ff9d00; }
        .shard-box p { margin: 0; color: #888; letter-spacing: 2px; }
        .add-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { background: #333; border: 1px solid #444; color: white; padding: 10px; flex: 1; border-radius: 5px; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; }
        .btn-add { background: #ff9d00; color: black; }
        .account-card { background: #1e1e1e; border-radius: 8px; margin-bottom: 10px; padding: 15px; border-left: 5px solid #444; }
        .account-card.online { border-left-color: #00ff00; }
        .card-top { display: flex; justify-content: space-between; align-items: center; }
        .shards-pill { background: #333; color: #00ff00; padding: 2px 8px; border-radius: 10px; font-size: 0.9em; margin-top: 5px; display: inline-block; }
        .btn-con { background: #28a745; color: white; }
        .btn-dis { background: #dc3545; color: white; }
        .btn-refresh { background: #007bff; color: white; font-size: 0.7em; padding: 4px 8px; margin-left: 10px; vertical-align: middle; }
        .chat-drawer { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .chat-flex { display: flex; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="shard-box">
        <p>TOTAL NETWORK SHARDS</p>
        <h1 id="totalShards">0</h1>
    </div>

    <div class="add-box">
        <input type="text" id="emailInput" placeholder="Enter Microsoft Email">
        <button class="btn-add" onclick="addAccount()">+ Add Bot</button>
    </div>

    <div id="botList"></div>
</div>

<script>
    async function addAccount() {
        const email = document.getElementById('emailInput').value;
        if (!email) return;
        await fetch(`/add?email=${encodeURIComponent(email)}`);
        document.getElementById('emailInput').value = '';
        updateUI();
    }

    async function trigger(action, email) {
        await fetch(`/${action}?email=${encodeURIComponent(email)}`);
        updateUI();
    }

    async function refreshShards(email) {
        const btn = event.target;
        btn.innerText = "Wait...";
        await fetch(`/update-shards?email=${encodeURIComponent(email)}`);
        updateUI();
    }

    async function sendChat(email) {
        const safeId = email.replace(/[@.]/g, '');
        const input = document.getElementById(`msg-${safeId}`);
        const text = input.value;
        if (!text) return;
        
        await fetch(`/chat?email=${encodeURIComponent(email)}&message=${encodeURIComponent(text)}`);
        input.value = '';
    }

    async function updateUI() {
        const res = await fetch('/status');
        const bots = await res.json();
        const list = document.getElementById('botList');
        let totalShards = 0;
        let html = '';

        bots.forEach(bot => {
            const shards = parseInt(bot.shards) || 0;
            totalShards += shards;
            const isOnline = bot.status === 'Online';
            const safeId = bot.email.replace(/[@.]/g, '');

            html += `
                <div class="account-card ${isOnline ? 'online' : ''}">
                    <div class="card-top">
                        <div class="info">
                            <h3>${bot.username || 'Connecting...'}</h3>
                            <small>${bot.email} â€¢ ${bot.status}</small><br>
                            <span class="shards-pill">${shards.toLocaleString()} Shards</span>
                            <button class="btn-refresh" onclick="refreshShards('${bot.email}')">Update</button>
                        </div>
                        <div>
                            ${isOnline 
                                ? `<button class="btn-dis" onclick="trigger('disconnect', '${bot.email}')">Disconnect</button>`
                                : `<button class="btn-con" onclick="trigger('connect', '${bot.email}')">Connect</button>`
                            }
                        </div>
                    </div>
                    ${isOnline ? `
                    <div class="chat-drawer">
                        <div class="chat-flex">
                            <input type="text" id="msg-${safeId}" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat('${bot.email}')">
                            <button class="btn-add" onclick="sendChat('${bot.email}')">Send</button>
                        </div>
                    </div>` : ''}
                </div>`;
        });

        // We only update innerHTML if the content is actually different to prevent 
        // losing focus on the input fields while typing.
        if (list.innerHTML !== html) {
            list.innerHTML = html;
        }
        document.getElementById('totalShards').innerText = totalShards.toLocaleString();
    }

    setInterval(updateUI, 3000);
    updateUI();
</script>

</body>
</html>
